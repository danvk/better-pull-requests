{%- extends "base.html" -%}

{% block title %} File Diff View {% endblock %}

{% block head %}
{% endblock %}

{% block body %}
<div id="refresh-update-available">There's something new!
  <a href="#" onclick="location.reload();">Reload</a> the page to see it.
</div>

<div class="wrap">

<a class="github-link" href="{{ pull_request.html_url }}" title="View on github.com"><span class="github-icon"></span></a>
<h2><a href="{{pull_request_url}}">{{pull_request.title}}</a></h2>

<div class="description">{{pull_request.body}}</div>

<a name="commits"></a>
<h3>Commits</h3>
{% include 'commit_list.html' %}

<a name="files-changed"></a>
<h3>Files Changed</h3>
<div id="files-changed">
  {% for f in files %}
    {% if f.path == path %}
    <div class="diff-link diff-current">
      {{f.path}}
    </div>
    {% else %}
    <div class="diff-link">
      <a href="{{f.link}}">{{f.path}}</a>
    </div>
    {% endif %}
  {% endfor %}
</div>

{% if prev_file or next_file %}
<div id="prev-next">
  {% if prev_file %}
    <a class="prev" href="{{prev_file.link}}">&larr; {{prev_file.path}}</a>
  {% endif %}
  &nbsp;
  {% if next_file %}
    <a class="next" href="{{next_file.link}}">{{next_file.path}} &rarr;</a>
  {% endif %}
</div>
{% endif %}

</div>

<hr/>

<a name="diff"></a>
<h3 name="diff">{{path}}</h3>
<div id="thediff"></div>

{% include 'comment_templates.html' %}

<script type="text/javascript">
var logged_in_user = {{logged_in_user|tojson}};
var pr_owner = {{pull_request.user.login|tojson}};

var beforeContents = {{before_contents|tojson|safe}};
var afterContents = {{after_contents|tojson|safe}};

var sha1 = {{sha1|tojson|safe}};
var sha2 = {{sha2|tojson|safe}};

var owner = {{owner|tojson}};
var repo = {{repo|tojson}};
var path = {{path|tojson}};
var pr_number = {{pull_request.number|tojson}};
var updated_at = {{pull_request.updated_at|tojson}};

var diff_comments = {{comments.diff_level|tojson|safe}};
var pull_request_url = {{pull_request_url|tojson}};
var github_file_urls = {{github_file_urls|tojson}};
</script>

<script src="/static/js/file_diff.js"></script>
<script type="text/javascript">
$(function() {
  displayDiffs(sha1, sha2, beforeContents, afterContents);

  // Simplify comment view
  $('.comment-body').map(function(_, div) { collapseQuotes(div) });

  // Format descriptions with markdown.
  $('.description').html(
    new Showdown.converter().makeHtml({{pull_request.body|tojson|safe}}));

  attachHandlers();

  // Add github links to the files
  var $titles = $('#thediff').find('th.texttitle');
  if ($titles.length == 2) {
    $titles.each(function(i, title) {
      var $link = $($('.github-link').get(0)).clone();
      $link.find('.github-icon').addClass('github-icon-16');
      $link.attr('href', github_file_urls[i]);
      $link.find('img').attr('src', '16px');
      $(title).append($link);
    });
  }

  checkForUpdates(owner, repo, pr_number, updated_at);
});
</script>
{% endblock %}
