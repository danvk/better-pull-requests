<!doctype html>
<head>
  <title>File Diff View</title>
  <link rel=stylesheet href="/static/jsdifflib/diffview.css">
  <link rel=stylesheet href="/static/pull_request.css">
</head>
<body>
<h2>Commits</h2>
{% for commit in commits %}
<input name='left' type=radio sha={{commit.sha}}>
<input name='right' type=radio sha={{commit.sha}}>
{{commit.time}}
{{commit.sha}}
{{commit.message}}
{{commit.author}} ({{commit.comment_count}} comments)
<br>
{% endfor %}

<p><button id="diff">Show Diff</button></p>

<h2>{{path}}</h2>
<div id="thediff"></div>

<h2>Files Changed</h2>
<div id="files-changed">
{% for differing_file in differing_files %}
{% if differing_file.path == path %}
<div class="diff-link diff-current">
  {{differing_file.path}}
</div>
{% else %}
<div class="diff-link">
  <a href="{{differing_file.link}}">{{differing_file.path}}</a>
</div>
{% endif %}
{% endfor %}
</div>

<script src="/static/jquery-2.1.1.min.js"></script>
<script src="/static/underscore-min.js"></script>
<script src="/static/jsdifflib/difflib.js"></script>
<script src="/static/jsdifflib/diffview.js"></script>
<script src="/static/pull_request.js"></script>

<script type="text/javascript">
var beforeContents = {{before_contents|tojson|safe}};
var afterContents = {{after_contents|tojson|safe}};

function displayDiffs(before_ref, after_ref, baseTxt, afterTxt) {
  var diffDiv = renderDiff(baseTxt, afterTxt);

  $('#thediff').append(diffDiv);

  var comments = _.filter(diff_comments, function(comment) {
      return (comment.original_commit_id == after_ref ||
              comment.original_commit_id == before_ref) &&
          comment.path == {{path|tojson}};
  });

  comments.map(function(comment) {
    var pos =
        parseDiffPosition(comment.diff_hunk, comment.original_position);
    if (comment.original_commit_id == before_ref) {
      pos.onLeft = !pos.onLeft;
    }

    var lineEl = findDomElementForPosition(diffDiv, pos);
    $(lineEl).append(renderComment(comment));
  });
}

var head_repo = {{head_repo|tojson|safe}};
var diff_comments = {{comments.diff_level|tojson|safe}};

$(function() {
  $('#diff').click(function() {
  });

  // Simplify comment view
  $('.comment-body').map(function(_, div) { collapseQuotes(div) });

  displayDiffs({{sha1|tojson|safe}}, {{sha2|tojson|safe}}, beforeContents, afterContents);
});
</script>
</body>
</html>
