<!doctype html>
<head>
  <title>Pull Request View</title>
  <link rel=stylesheet href="/static/jsdifflib/diffview.css">
  <link rel=stylesheet href="/static/pull_request.css">
</head>
<body>
<h2>{{pull_request.title}}</h2>
<p class="description">{{pull_request.body}}</p>

<h2>Commits</h2>
{% for commit in commits %}
<input name='left' type=radio sha={{commit.sha}}>
<input name='right' type=radio sha={{commit.sha}}>
{{commit.author.date}}
<span class='sha'>{{commit.sha|truncate(7, True, end='')}}</span>
{{commit.commit.message}}
{{commit.author.login}}
{%if commit.comment_count > 0 %}({{commit.comment_count}} comments){%endif%}
<br>
{% endfor %}

<p><button id="diff">Show Diff</button></p>

<h2>Files Changed</h2>
<div id="files-changed"></div>

<h2>Discussion</h2>
{% for comment in comments.top_level %}
<p>{{comment.updated_at}} {{comment.user.login}}:<br>
<div class="comment-body">{{comment.body}}</div></p>
<hr/>
{% endfor %}

<script src="/static/jquery-2.1.1.min.js"></script>
<script src="/static/underscore-min.js"></script>
<script src="/static/jsdifflib/difflib.js"></script>
<script src="/static/jsdifflib/diffview.js"></script>
<script src="/static/showdown/showdown.js"></script>
<script src="/static/showdown/github.js"></script>
<script src="/static/pull_request.js"></script>

<script type="text/javascript">
var user = {{user|tojson}};
var repo = {{repo|tojson}};
var pr_number = {{pull_request.number|tojson}};

// TODO(danvk): do this server-side in Jinja, not in JavaScript
function displayDiffs(before_ref, after_ref, data) {
  $('#files-changed').empty();
  var diffUrlBase = '/pull/' + user + '/' + repo + '/' + pr_number + '/diff';
  data.files.forEach(function(file) {
    var diffUrl = diffUrlBase +
        '?path=' + escape(file) +
        '&sha1=' + escape(before_ref) +
        '&sha2=' + escape(after_ref);
    $('#files-changed').append($('<a href></a>').text(file).attr('href', diffUrl));
  });
  $('#files-changed a').wrap('<div class=diff-link></div>');
}

$(function() {
  $('#diff').click(function() {
    $('#files-changed').html('&hellip;');

    var sha1 = $('input[name="left"]:checked').attr('sha'),
        sha2 = $('input[name="right"]:checked').attr('sha');
        $.getJSON('/diff', { user: user, repo: repo, sha1: sha1, sha2: sha2 })
        .success(function(data) {
          displayDiffs(sha1, sha2, data);
        })
        .error(function(err) {
          $('#files-changed').text(JSON.stringify(err));
        });
  });

  // Default view
  $('input[name=left]:last').click();
  $('input[name=right]:first').click();
  $('#diff').click();

  // Simplify comment view
  $('.comment-body').map(function(_, div) { collapseQuotes(div) });

  // Format descriptions with markdown.
  $('.description').html(new Showdown.converter().makeHtml({{pull_request.body|tojson|safe}}));
});
</script>

</body>
