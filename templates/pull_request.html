<!doctype html>
<head>
  <title>Pull Request View</title>
  <link rel=stylesheet href="/static/jsdifflib/diffview.css">
  <style>
.diff {
  max-width: 1600px;
}
.comment-body {
  white-space: pre;
}
.inline-comment {
  background: lightgray;
  border: 1px solid black;
  padding: 3px;
  margin: 3px -0.3em;
}
  </style>
</head>
<body>
<h2>Commits</h2>
{% for commit in commits %}
<input name='left' type=radio sha={{commit.sha}}>
<input name='right' type=radio sha={{commit.sha}}>
{{commit.time}}
{{commit.sha}}
{{commit.message}}
{{commit.author}} ({{commit.comment_count}} comments)
<br>
{% endfor %}

<p><button id="diff">Show Diff</button></p>

<h2>Files Changed</h2>
<div id="files-changed"></div>

<h2>Discussion</h2>
{% for comment in comments.top_level %}
<p>{{comment.updated_at}} {{ comment.user.login }}:<br>
<div class="comment-body">{{comment.body}}</div></p>
<hr/>
{% endfor %}

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//underscorejs.org/underscore.js"></script>
<script src="/static/jsdifflib/difflib.js"></script>
<script src="/static/jsdifflib/diffview.js"></script>
<script type="text/javascript">
function filterObject(obj, fn) {
  var ret = {};
  for (var k in obj) {
    if (fn(k, obj[k])) {
      ret[k] = obj[k]
    }
  }
  return ret;
}

function displayDiffs(before_ref, after_ref, data) {
  $('#files-changed').empty();
  data.files.forEach(function(file) {
      var baseTxt = data.before[file] || '';
      var afterTxt = data.after[file] || '';

      var diffoutputdiv = $('<div class="diff"></div>').get(0);

      // From https://github.com/cemerick/jsdifflib
      var baseLines = difflib.stringAsLines(baseTxt);
      var afterLines = difflib.stringAsLines(afterTxt);

      // create a SequenceMatcher instance that diffs the two sets of lines
      var sm = new difflib.SequenceMatcher(baseLines, afterLines);

      // get the opcodes from the SequenceMatcher instance
      // opcodes is a list of 3-tuples describing what changes should be made to the base text
      // in order to yield the new text
      var opcodes = sm.get_opcodes();
      var contextSize = 10;

      // build the diff view and add it to the current DOM
      diffoutputdiv.appendChild(diffview.buildView({
          baseTextLines: baseLines,
          newTextLines: afterLines,
          opcodes: opcodes,
          // set the display titles for each resource
          baseTextName: "Before",
          newTextName: "After",
          contextSize: contextSize,
          viewType: 0
      }));

      $('#files-changed').append(['<h2>' + file + '</h2>', diffoutputdiv]);

      // TODO(danvk): show comments on the 'before' side, too.
      var comments = _.filter(diff_comments, function(comment) {
          return comment.original_commit_id == after_ref &&
              comment.path == file;
      });

      comments.map(function(comment) {
          var diff_hunk_lines = comment.diff_hunk.split('\n');
          var diff_header = diff_hunk_lines[0];
          var m = /^@@ (-?[0-9]+),([0-9]+) (\+?[0-9]+),([0-9]+) @@/.exec(diff_header);
          if (!m) {
            console.warn("Couldn't parse diff header", diff_header);
            return;
          }
          var line_no = parseInt(m[3], 10);
          // comment.original_position = line number in the unified diff.
          // sometimes it's way larger than the number of lines in the diff.
          // In these cases, github shows it at the end of the diff.
          // We mirror this behavior.
          for (var i = 0; i < Math.min(comment.original_position, diff_hunk_lines.length); i++) {
            if (diff_hunk_lines[i].substr(0, 1) != '-') {
              line_no++;
            }
          }

          var $diff_td = $(diffoutputdiv).find('.after.line-' + line_no);
          if ($diff_td.length == 0) {
            console.warn('Unable to display comment on diff', comment);
            return;
          }

          $diff_td.append($('<div class="inline-comment"></div>').text(comment.user + ' ' + comment.time + '\n' + comment.body));
      });
  });
}

// Like itertools.groupBy, not _.groupBy
function groupConsecutive(arr, fn) {
  var groups = [];
  var current, last;
  for (var i = 0; i < arr.length; i++) {
    var val = fn(arr[i]);
    if (i == 0 || val != last) {
      if (current) groups.push(current);
      current = [arr[i]];
      last = val;
    } else {
      current.push(arr[i]);
    }
  }
  if (current) groups.push(current);
  return groups;
}

// Change '> So and so wrote:' to '<a href>...</a>'
function collapse_quotes(div) {
  var lines = $(div).html().split('\n');
  var groupedLines =
    groupConsecutive(lines, function(line) { return line.substr(0, 4) == '&gt;' });

  var result = [];
  for (var i = 0; i < groupedLines.length; i++) {
    var group = groupedLines[i];
    var is_quoted = (group[0].substr(0, 4) == '&gt;');
    if (is_quoted) {
      var $link = $('<a class=collapsed-ellipsis href=#>&hellip;</a>').data('contents', group.join('\n'));
      result.push($link);
    } else {
      result.push(group.join('\n'));
    }
  }
  $(div).empty().append(result);
}

var head_repo = {{head_repo|tojson|safe}};
var diff_comments = {{comments.diff_level|tojson|safe}};

$(function() {
  
  $('#diff').click(function() {
    $('#files-changed').html('&hellip;');

    var sha1 = $('input[name="left"]:checked').attr('sha'),
        sha2 = $('input[name="right"]:checked').attr('sha');
        $.getJSON('/diff', { repo: head_repo, sha1: sha1, sha2: sha2 })
        .success(function(data) {
          displayDiffs(sha1, sha2, data);
        })
        .error(function(err) {
          $('#files-changed').text(JSON.stringify(err));
        });
  });

  // Default view
  $('input[name=left]:last').click();
  $('input[name=right]:first').click();
  $('#diff').click();

  // Simplify comment view
  $('.comment-body').map(function(_, div) { collapse_quotes(div) });
});
</script>

</body>
